<html>
<meta charset="UTF-8">
<head>
  <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>

  <link rel="stylesheet" type="text/css" href="css/vizstyle.css">
</head>


<body>

  <div class="viz-title-container">
    <div class="viz-title">
      High Risks and Low Returns
    </div>

    <div class="viz-description">
      <p>Prosper is a P2P lending platform that allows investors to choose among personal loans to invest in. They do that by considering a number of factors, which include a custom calculated <span style="font-weight: normal">Prosper Score</span> that represents the risk for each loan. The higher the score, the lower the risk, and the lower the interest rates paid by the borrower to the investors.</p>

      <p>However, on average, loans with a Prosper Score of 2-4 (<i>higher risk expected</i>) had similar proportions of bad loans (defaulted loans, charged off loans or loans past due) as loans with a score of 6-8 (<i>lower risk expected</i>). In other words, investors who invested in loans with a score of 6-8 expected <i>lower risk</i> loans — and received <i>lower rates</i> in return — but ended up with risky loans just the same.</p>
    </div>
  </div>

  <div id="chart1Container">
  </div>

  <div id="chart2Container">
  </div>

  <script type="text/javascript">

    // Draw reference lines
    var drawLinesBetweenBars = function (chartNum, firstBar, secondBar) {
      // Arguments should all be integers
      // Hide gridlines but keep gridline container so we can draw reference lines
      var chart = d3.select("#chart"+chartNum+"Container")
      chart.select(".dimple-gridline").selectAll(".tick").html("");

      // Get y pixels for bars
      var firstBar_y = parseInt(chart.select(".dimple-"+firstBar).attr("y"));
      var secondBar_y = parseInt(chart.select(".dimple-"+secondBar).attr("y"));

      // Draw lines
      chart.select(".dimple-gridline").append("line")
        .style("stroke","lightgrey").attr("x1",0).attr("x2",510)
        .attr("y1",firstBar_y).attr("y2",firstBar_y).attr("stroke-dasharray", "5,5");
      chart.select(".dimple-gridline").append("line")
        .style("stroke","lightgrey").attr("x1",0).attr("x2",510)
        .attr("y1",secondBar_y).attr("y2",secondBar_y).attr("stroke-dasharray", "5,5");
    }


    var drawAnnotationBetweenBars = function (chartNum, firstBar, secondBar, heightOfBar, text) {

      var tickHeight = 7;

      var chart = d3.select("#chart"+chartNum+"Container");
      var annotationGroup = chart.select(".annotation-group");

      // Set pixel values
      var x1 = parseInt(chart.select(".dimple-"+firstBar).attr("x"));
      var x2 = parseInt(chart.select(".dimple-"+secondBar).attr("x")) +
               parseInt(chart.select(".dimple-"+secondBar).attr("width"));
      var y = chart.select(".dimple-"+heightOfBar).attr("y") - 20;

      // Draw lines
      annotationGroup.append("line")
        .style("stroke","black").attr("x1",x1).attr("x2",x2)
        .attr("y1",y).attr("y2",y);
      annotationGroup.append("line")
        .style("stroke","black").attr("x1",x1).attr("x2",x1)
        .attr("y1",y).attr("y2",y+tickHeight);
      annotationGroup.append("line")
        .style("stroke","black").attr("x1",x2).attr("x2",x2)
        .attr("y1",y).attr("y2",y+tickHeight);
      var halfway = (x1+x2)/2;
      annotationGroup.append("line")
        .style("stroke","black").attr("x1",halfway).attr("x2",halfway)
        .attr("y1",y).attr("y2",y-tickHeight);

      // Draw text
      var txt = annotationGroup.append("text")
        .classed("annotation", true)
        .classed("current-annotation", true)
        .style("font-family", "sans-serif")
        .style("font-size", "14px")
        .style("font-weight", "lighter")
        .text(text);
      var txtElem = document.getElementsByClassName("current-annotation");
      var bbox = txtElem[0].getBBox();
      txt.attr("x",halfway - bbox.width/2).attr("y",y - 14);
      txt.classed("current-annotation", false)
    }

    var drawAnnotations = function () {

      d3.selectAll("svg")
        .select(".dimple-chart")
        .append("g")
        .attr("class", "annotation-group");

      drawAnnotationBetweenBars(1, 3, 3, 3, "Higher Return");
      drawAnnotationBetweenBars(1, 7, 7, 7, "Lower Return");
      drawAnnotationBetweenBars(2, 3, 7, 5, "Similar Risk");
    }


    var highlightBar = function (chartNum, barNum) {

      d3.select("#chart"+chartNum+"Container")
        .select(".dimple-"+barNum)
        .style("fill", "#80B1D3")
        .style("stroke", "#80B1D3");
    }


    function draw(data) {

      // Set chart limits
      var chartContainerWidth = 600;
      var chartContainerHeight = 400;

      var chartBoundsX = "10%";
      var chartBoundsY = "10%";
      var chartBoundsWidth = "85%";
      var chartBoundsHeight = "75%";

      // Set up first chart
      var svg1 = dimple.newSvg("#chart1Container", chartContainerWidth, chartContainerHeight);
      var ratePerScoreChart = new dimple.chart(svg1, data);
      ratePerScoreChart.setBounds(chartBoundsX,
                                  chartBoundsY,
                                  chartBoundsWidth,
                                  chartBoundsHeight);
      ratePerScoreChart.defaultColors = [
        new dimple.color("lightgrey")
      ];

      // Set up axes
      var x1 = ratePerScoreChart.addCategoryAxis("x", "ProsperScore");
      x1.title = "Prosper Score";
      var y1 = ratePerScoreChart.addMeasureAxis("y", "MeanRatePerScore");
      y1.title = "Mean Interest Rate";
      y1.overrideMax = 0.35;

      // Add data series
      ratePerScoreSeries = ratePerScoreChart.addSeries("ProsperScore", dimple.plot.bar);

      // Set tooltip
      ratePerScoreSeries.getTooltipText = function (e) {
        return [
            "Prosper Score: "+e.x,
            "Mean Interest Rate: "+e.y.toFixed(2)
          ];
      };

      ratePerScoreChart.draw();


      /****************************************************************************************/
      // Set up second chart
      var svg2 = dimple.newSvg("#chart2Container", chartContainerWidth, chartContainerHeight);
      var ProportionBadPerScoreChart = new dimple.chart(svg2, data);
      ProportionBadPerScoreChart.setBounds(chartBoundsX,
                                           chartBoundsY,
                                           chartBoundsWidth,
                                           chartBoundsHeight);
      ProportionBadPerScoreChart.defaultColors = [
        new dimple.color("lightgrey")
      ];

      // Set up axes
      var x2 = ProportionBadPerScoreChart.addCategoryAxis("x", "ProsperScore");
      x2.title = "Prosper Score";
      var y2 = ProportionBadPerScoreChart.addMeasureAxis("y", "PropBadPerScore");
      y2.title = "Proportion of Bad Loans";
      y2.overrideMax = 0.35;

      ProportionBadPerScoreSeries = ProportionBadPerScoreChart.addSeries("ProsperScore", dimple.plot.bar);

      // Set tooltip
      ProportionBadPerScoreSeries.getTooltipText = function (e) {
        return [
            "Prosper Score: "+e.x,
            "Proportion of Bad Loans: "+e.y.toFixed(2)
          ];
      };

      ProportionBadPerScoreChart.draw();

      /****************************************************************************************/
      // Draw annotations and highlight select bars on both charts
      drawAnnotations();
      highlightBar(1, 3);
      highlightBar(1, 7);
      highlightBar(2, 3);
      highlightBar(2, 7);

      // Hide all gridlines
      d3.selectAll(".dimple-gridline").selectAll(".tick").html("");
    }
  </script>

  <script type="text/javascript">
    // Read data using d3 and pass it to the draw function
    d3.csv("/data/prosper_loans_export.csv", draw);
  </script>

</body>
</html>
